<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0a1628">
  <title>Oráculo — Entre Mundos</title>
  <style>
    :root { --bg:#0a1628; --fg:#e9f0ff; --muted:#9db3ff; --panel:#0f2342; }
    html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 50% -10%,#123064,var(--bg)); color:var(--fg);
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:740px;margin:0 auto;padding:20px 16px 44px;}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
    .btn{background:#15325f;color:var(--fg);border:1px solid #28508a;border-radius:12px;padding:10px 14px;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:8px}
    h1{font-size:22px;margin:0;letter-spacing:.3px;}
    .muted{color:var(--muted)}
    .panel{background:rgba(15,35,66,.66);border:1px solid #25406d;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.28), inset 0 0 40px rgba(255,255,255,.02);}
    .oracle{display:grid;place-items:center;min-height:360px;text-align:center;padding:12px 14px;}
    .msg{font-size:22px;line-height:1.45;opacity:0;transform:translateY(6px);min-height:2.6em;text-wrap:balance}
    .show{animation:fadeIn .45s ease forwards;} @keyframes fadeIn{to{opacity:1;transform:translateY(0);}}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px;}
    button{background:#193b74;color:var(--fg);border:1px solid #2b4b82;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:transform .06s ease;}
    button:active{transform:scale(.98);}
    .bottom{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .counter{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="btn" href="index-fase2.html?v=32">← Voltar</a>
      <div style="margin-left:auto;text-align:right">
        <h1 style="margin:0">Oráculo — Entre Mundos</h1>
        <div class="muted">Toca em “Abrir Oráculo” e recebe a tua mensagem.</div>
      </div>
    </header>

    <section class="panel">
      <div class="oracle">
        <div id="message" class="msg">Pronto para abrir o oráculo?</div>
      </div>

      <div class="row">
        <button id="open">Abrir Oráculo</button>
        <button id="another" style="display:none">Nova mensagem</button>
        <button id="copy" style="display:none">Copiar</button>
      </div>

      <div class="bottom">
        <span class="counter" id="counter"></span>
        <a class="btn" href="index-fase2.html?v=32">← Voltar ao menu</a>
      </div>
    </section>

    <footer>Entre Mundos — Oráculo</footer>
  </div>

<script>
function normalize(data){ if(Array.isArray(data))return data; if(data&&Array.isArray(data.mensagens))return data.mensagens; if(data&&Array.isArray(data.messages))return data.messages; return []; }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function cleanTailNumber(s){ return (s||'').replace(/\s*\(\s*\d+\s*\)\s*$/, '').trim(); }

let ALL=[], deck=[], idx=-1;
const STORAGE_KEY='entre-mundos-oraculo-deck-v18';

const msgEl=document.getElementById('message');
const btnOpen=document.getElementById('open');
const btnAnother=document.getElementById('another');
const btnCopy=document.getElementById('copy');
const counterEl=document.getElementById('counter');

function show(text){ msgEl.classList.remove('show'); setTimeout(()=>{ msgEl.textContent=text; msgEl.classList.add('show'); },10); }
function updateCounter(){ if(!deck.length){counterEl.textContent='';return;} counterEl.textContent=(idx+1)+' de '+deck.length; }
function newDeck(){ deck=shuffle(ALL.slice()); idx=-1; localStorage.setItem(STORAGE_KEY, JSON.stringify({deck,idx})); }
function nextMessage(){ if(!deck.length)return 'Sem mensagens.'; idx++; if(idx>=deck.length){ newDeck(); idx=0; } localStorage.setItem(STORAGE_KEY, JSON.stringify({deck,idx})); return deck[idx]; }
function resetUI(){ btnOpen.style.display='inline-block'; btnAnother.style.display='none'; btnCopy.style.display='none'; show('Pronto para abrir o oráculo?'); idx=-1; updateCounter(); }

async function loadMessages(){ 
  try{ const resp=await fetch('oraculo.json?ts='+Date.now(),{cache:'no-store'}); const data=await resp.json(); ALL=normalize(data).map(cleanTailNumber).filter(Boolean); }
  catch(e){ ALL=['Respira. O silêncio não é vazio — é casa.','És amado mesmo quando duvidas de ti.']; }
  try{ const saved=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); 
       if(saved && Array.isArray(saved.deck) && typeof saved.idx==='number' && saved.deck.length===ALL.length){ deck=saved.deck; idx=Math.max(-1, Math.min(saved.idx, deck.length-1)); }
       else { newDeck(); }
  } catch(e){ newDeck(); }
  if(idx>=0){ show(deck[idx]); btnOpen.style.display='none'; btnAnother.style.display='inline-block'; btnCopy.style.display='inline-block'; }
  updateCounter();
}

resetUI(); loadMessages();

btnOpen.addEventListener('click', ()=>{ const t=nextMessage(); show(t); btnOpen.style.display='none'; btnAnother.style.display='inline-block'; btnCopy.style.display='inline-block'; updateCounter(); });
btnAnother.addEventListener('click', ()=>{ show(nextMessage()); updateCounter(); });
btnCopy.addEventListener('click', async ()=>{ const text=msgEl.textContent.trim(); try{ await navigator.clipboard.writeText(text); btnCopy.textContent='Copiado ✓'; setTimeout(()=>btnCopy.textContent='Copiar',1000); }catch(e){} });
</script>
</body>
</html>
